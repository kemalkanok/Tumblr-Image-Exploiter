from urllib2 import HTTPError
import urllib2 , json , os.path , sys , socks , socket
start = 1
socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, "127.0.0.1", 1234)
socket.socket = socks.socksocket
def generateurl(url,page=1):
	tumblrurl = "http://api.tumblr.com/v2/blog/"+url+".tumblr.com/posts?type=photo&api_key=REVdGcfNlXa4vBx2ZFFvcXnOwhkEYChsx3g0W6ERvxtTVOcJBy&offset="
	tumblrurl += str((page-1)*20)
	print tumblrurl #@debug: url test
	return tumblrurl
def getContent(url):
	try:
		data = urllib2.urlopen(url).read()
		# print data
		externaldata = json.loads(data)
	except HTTPError:
		return getContent(url)
	#print externaldata #@debug , json parsing test
	return externaldata
def checkJson(data):
	return data["meta"]["status"] == 200
def getImages(data):
	if checkJson(data):
		# print "move on"
		pass
	else:
		print "tumblr blog not found or not accessible!"
	datas = data["response"]["posts"]
	result = []
	for x in range(len(datas)):
		j = len(datas[x]["photos"])
		for y in range(j):
			result.append(datas[x]["photos"][y]["original_size"]["url"])
	# print len(datas)
	# print result#@debug : jsonlist fill test
	return result
def downloadImages(src):
	if len(src) is 0:
		print "have a nice day"
		exit()
	for x in range(len(src)):
		el = src[x]
		downloadImage(el)
	pass
def downloadImage(url):
	filename =  url[url.rfind('/')+1:]
	# print filename#@debug filename test
	filename = "tumblr/"+filename
	if os.path.isfile(filename) != 1:
		print url + "\nnow downloading..."
		f = open(filename,'wb')
		f.write(urllib2.urlopen(url).read())
		f.close()
		print "done"
def test(suburl,start,status = 0):
	url = generateurl(suburl,start)
	start+=1
	# print start#@debug , counter tester
	data = getContent(url)
	images = getImages(data)
	downloadImages(images)
	if status is 0:
		if raw_input('again?[Y]/n')  in ['Y','y','']:
			again(suburl,start,status)
		else:
			print "have a nice day"
	else:
		again(suburl,start,status)
def again(suburl,start,status):
	test(suburl,start,status)
def get_args():
	key = {}
	key["force"] = 0
	key["name"] = "kemalkanok"
	for x in range(2,len(sys.argv)):
		el = sys.argv[x]
		if el.startswith("-url") :
			key["url"]=el[6:]
		elif el == "--force":
			key["force"] = 1
	ignite(key)
def ignite(key):
	test(key["name"],1,key["force"])
get_args()
